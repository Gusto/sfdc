/**
Author:        Robin Grover
Company:       Gusto
Description:   This is a test class for HIFulfillmentEventEmployeeUpdateTest

History
7/4/2017    Robin Grover     Initial Implementation
**/
@isTest
private class HIFulfillmentEventEmployeeUpdateTest {
    @testSetup
    static void makeData(){
        Blob blbEncryption = EncryptionUtils.generateKey('Master');
        List<Account> list_Accounts = new List<Account>();
        List<Contact> list_Contacts = new List<Contact>();

        Account objAccount1 = new Account(
            ZP_Company_ID__c = '7757616923580839',
            Name  = 'Test Account'
        );
        Account objAccount2 = new Account(
            ZP_Company_ID__c = '1404257697994579',
            Name  = 'Test Account2'
        );
        list_Accounts.add(objAccount1);
        list_Accounts.add(objAccount2);
        insert list_Accounts;

        Carrier__c objCarrier = new Carrier__c(
            Key__c = 'bcbs_ma',
            Name = 'Test Carrier',
            State__c = 'AL'
        );
        insert objCarrier;

        Contact objContact1 = new Contact(
            FirstName = 'Testing ', 
            LastName = 'Contact', 
            AccountId = objAccount1.Id, 
            ZP_User_Id__c = '7757869431528940'
        );

        Contact objContact2 = new Contact(
            FirstName = 'Testing ', 
            LastName = 'Contact', 
            AccountId = objAccount2.Id, 
            ZP_User_Id__c = '7757869434229598'
        );
        list_Contacts.add(objContact1);
        list_Contacts.add(objContact2);
        insert list_Contacts;
    }
    
    @isTest
    static void testEmployeeUpdate() {
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;

        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = 'Test321';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"error_message":"Test error","benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869431528940}],"updates":[{"type":"first_name","previous":{"first_name":"Harry"},"current":{"first_name":"Paul"}}],"updated_at":"2017-08-03","employee":{"id":7757869431528940,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":7757616923580839,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839/employees/7757869431528940","hippo_url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940"},"company":{"id":7757616923580839,"name":"Wisozk-Hermiston","email":"deanna7757869448866931@wisozk.org","salesforce_account_id":null,"work_states":["CA"],"sic_code":"4215","mailing_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"filing_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"benefits_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"number_of_eligible_ees":8,"number_of_ineligible_ees":11,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839","hippo_url":"http://localhost:4001/companies/7757616923580839"},"state_carriers":[{"id":22,"name":"Guardian","state":"CA","key":"guardian_ca","url":"http://localhost:4001/national_carriers/24/state_carriers/22"},{"id":1,"name":"Anthem Blue Cross of California","state":"CA","key":"anthem_ca","url":"http://localhost:4001/national_carriers/4/state_carriers/1"}],"subscriptions":[{"id":58499,"policy_id":7179,"benefit_type":"vision","subscriber_id":"46352272","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869431528940,"dependent_ids":[4644,9846],"state_carrier_id":22,"url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940/subscriptions/58499"},{"id":58498,"policy_id":7178,"benefit_type":"dental","subscriber_id":"44920713","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869431528940,"dependent_ids":[4644,9846],"state_carrier_id":22,"url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940/subscriptions/58498"},{"id":58497,"policy_id":7176,"benefit_type":"medical","subscriber_id":"40333004","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869431528940,"dependent_ids":[4644,9846],"state_carrier_id":1,"url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940/subscriptions/58497"}],"policies":[{"id":7179,"name":"Guardian EM Vision 12","benefit_type":"vision","group_number":"G-00532246","policy_number":null,"plan_id":1814,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":22,"url":"http://localhost:4001/companies/7757616923580839/policies/7179"},{"id":7178,"name":"Guardian EM Dental 13","benefit_type":"dental","group_number":"G-00532246","policy_number":null,"plan_id":1815,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":22,"url":"http://localhost:4001/companies/7757616923580839/policies/7178"},{"id":7176,"name":"Gold PPO 20/30%/5500","benefit_type":"medical","group_number":"J14947","policy_number":"J14947-1ZF9","plan_id":11,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":1,"url":"http://localhost:4001/companies/7757616923580839/policies/7176"}],"subscriptions_url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940/subscriptions"}';
        insert objHiFulfilment;
        Test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }
    
    @isTest
    static void testCompanyUpdateMailingAddress(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'company_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869434229598}],"updates":[{"type":"mailing_address","previous":{"mailing_address":{"id":7757727713943536,"street_1":"338 Francisca Streets","street_2":"Apt. 736","city":"Bainbridge Island","county_name":"Maricopa","state":"WA","zip":"98110","country":"USA","phone":"6253966771","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":null,"inactive":false,"work_address":true,"employee_count":1}},"current":{"mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1}}}],"updated_at":"2017-08-05","company":{"id":1404257697994579,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18439"}]}';
        insert objHiFulfilment;
        Test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testCompanyUpdateBankUpdate(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'company_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869431500092}],"employee":{"id":7757869431528940,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":7757616923580839,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839/employees/7757869431528940","hippo_url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940"},"updates":[{"type":"bank_account","previous":{"bank_account":{"account_type":"Checking","bank_name":"WELLS FARGO BANK NA","bank_account_last_four":"3485"}},"current":{"bank_account":{"account_type":"Checking","bank_name":"WELLS FARGO BANK NA","bank_account_last_four":"3486"}}}],"updated_at":"2017-08-05","company":{"id":7757616923580839,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839","hippo_url":"http://localhost:4001/companies/7757616923580839"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testCompanyUpdateFLSUpdate(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869434229598}],"employee":{"id":7757869434229598,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":1404257697994579,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579/employees/7757869434229598","hippo_url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598"},"updates":[{"type":"flsa_status","previous":{"flsa_status":"Old Status"},"current":{"flsa_status":"New Status"}}],"updated_at":"2017-08-05","company":{"id":1404257697994579,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18439"}]}';
                                        
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }
    
    @isTest
    static void testSalaryUpdate(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'company_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869434229598}],"employee":{"id":7757869434229598,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":1404257697994579,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579/employees/7757869434229598","hippo_url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598"},"updates":[{"type":"extrapolated_annual_salary","previous":{"extrapolated_annual_salary":"00000.00"},"current":{"extrapolated_annual_salary":"13500.00"}}],"updated_at":"2017-08-05","company":{"id":1404257697994579,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testMultipleUpdates(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        HIFulfillmentEventEmployeeUpdateJSON objEmployeeUpdateJson = new HIFulfillmentEventEmployeeUpdateJSON();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869431528940}],"employee":{"id":7757869431528940,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":7757616923580839,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839/employees/7757869431528940","hippo_url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940"},"updates":[{"type":"last_name","previous":{"last_name":"testOld"},"current":{"last_name":"TestNew"}},{"type":"ssn","previous":{"ssn":"SN214256152"},"current":{"ssn":"SN@78563948"}},{"type":"hired_at","previous":{"hired_at":"2019-05-26"},"current":{"hired_at":"2019-05-29"}},{"type":"birthday","previous":{"birthday":"1990-05-26"},"current":{"birthday":"1991-05-29"}}],"updated_at":"2017-08-05","company":{"id":7757616923580839,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839","hippo_url":"http://localhost:4001/companies/7757616923580839"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testStateCarrierMissing(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869434229598}],"employee":{"id":7757869431528940,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":1404257697994579,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579/employees/7757869431528940","hippo_url":"http://localhost:4001/companies/1404257697994579/employees/7757869431528940"},"updates":[{"type":"last_name","previous":{"last_name":"testOld"},"current":{"last_name":"TestNew"}},{"type":"ssn","previous":{"ssn":"SN214256152"},"current":{"ssn":"SN@78563948"}},{"type":"hired_at","previous":{"hired_at":"2019-05-26"},"current":{"hired_at":"2019-05-29"}},{"type":"birthday","previous":{"birthday":"1990-05-26"},"current":{"birthday":"1991-05-29"}}],"updated_at":"2017-08-05","company":{"id":1404257697994579,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.ERROR_STATE);
    }

    @isTest
    static void testCompanyIdMissing(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869431500092}],"employee":{"id":7757869431528940,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":"","hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839/employees/7757869431528940","hippo_url":"http://localhost:4001/companies/7757616923580839/employees/7757869431528940"},"updates":[{"type":"last_name","previous":{"last_name":"testOld"},"current":{"last_name":"TestNew"}},{"type":"ssn","previous":{"ssn":"SN214256152"},"current":{"ssn":"SN@78563948"}},{"type":"hired_at","previous":{"hired_at":"2019-05-26"},"current":{"hired_at":"2019-05-29"}},{"type":"birthday","previous":{"birthday":"1990-05-26"},"current":{"birthday":"1991-05-29"}}],"updated_at":"2017-08-05","company":{"id":7757616923580839,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839","hippo_url":"http://localhost:4001/companies/7757616923580839"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.ERROR_STATE);
    }

    @isTest
    static void testMissingBenefitItems(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"employee":{"id":7757869434229598,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":1404257697994579,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579/employees/7757869434229598","hippo_url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598"},"updates":[{"type":"flsa_status","previous":{"flsa_status":"Old Status"},"current":{"flsa_status":"New Status"}}],"updated_at":"2017-08-05","company":{"id":1404257697994579,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/1404257697994579/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/1404257697994579/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.DEAD_STATE);
    }

    @isTest
    static void testCompanyUpdateFilingAddress(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'company_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869431528940}],"updates":[{"type":"filing_address","previous":{"filing_address":{"id":7757727713943536,"street_1":"338 Francisca Streets","street_2":"Apt. 736","city":"Bainbridge Island","county_name":"Maricopa","state":"WA","zip":"98110","country":"USA","phone":"6253966771","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":null,"inactive":false,"work_address":true,"employee_count":1}},"current":{"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35}}}],"updated_at":"2017-08-05","company":{"id":7757616923580839,"name":"Adams Inc","email":"korbin1404257697956813@schoencole.co","salesforce_account_id":null,"work_states":["AZ","CA","WA"],"sic_code":"8999","mailing_address":{"id":7757727713943536,"street_1":"7800 Friesen Estates","street_2":"Apt. 506","city":"Gilbert","county_name":"Maricopa","state":"AZ","zip":"85298","country":"USA","phone":"2078241716","created_at":"2017-05-23T10:07:13.000-07:00","updated_at":"2017-05-23T10:07:25.000-07:00","fax":"1106998127","inactive":false,"work_address":true,"employee_count":1},"filing_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"benefits_address":{"id":1404257784740974,"street_1":"8221 Della Roads","street_2":"Suite 217","city":"Palo Alto","county_name":"Santa Clara","state":"CA","zip":"94301","country":"USA","phone":"7537615975","created_at":"2014-07-01T16:36:24.000-07:00","updated_at":"2017-04-14T11:37:34.000-07:00","fax":"4170697172","inactive":false,"work_address":true,"employee_count":35},"number_of_eligible_ees":19,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923580839","hippo_url":"http://localhost:4001/companies/7757616923580839"},"state_carriers":[{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2"},{"id":21,"name":"CoPower","state":"CA","key":"co_power_ca","url":"http://localhost:4001/national_carriers/12/state_carriers/21"}],"policies":[{"id":21129,"name":"Gold Access+ HMO (R) 1700/30 OffEx","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":3524,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/21129"},{"id":20911,"name":"Platinum Full PPO 150/15 [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2725,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20911"},{"id":20910,"name":"Platinum Access+ HMO 0/25 OffEx [2017]","benefit_type":"medical","group_number":"W0058597","policy_number":null,"plan_id":2547,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":2,"url":"http://localhost:4001/companies/7757616923580839/policies/20910"},{"id":18440,"name":"VSP Signature Affiliate Enh B $25 ","benefit_type":"vision","group_number":"902777","policy_number":null,"plan_id":2411,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18440"},{"id":18439,"name":"Delta Dental PPO $2000","benefit_type":"dental","group_number":"902777","policy_number":null,"plan_id":3374,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":21,"url":"http://localhost:4001/companies/7757616923580839/policies/18439"}]}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testCompanyUpdateHomeAddress(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'company_update';
        objHiFulfilment.Event_Info__c = '{"benefit_items":[{"state_carrier_id":22,"id":21225,"policy_id":6135,"benefit_type":"life","start_date":"2016-09-01","end_date":"2017-08-31","employee_id":7757869434229598}],"updates":[{"type":"home_address","previous":{"home_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19}},"current":{"home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false}}}],"updated_at":"2017-08-03","employee":{"id":7757869434229598,"first_name":"Garea","last_name":"Law","middle_initial":"","status":"Active","ssn":"123454912","birthday":"1985-01-27","company_id":1404257697994579,"hired_at":"2016-08-15","employment_status":"full_time","home_address":{"id":7757727713544802,"street_1":"730 DuBuque Forest","street_2":"Suite 998","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94108","country":"USA","phone":null,"created_at":"2016-08-16T13:52:18.000-07:00","updated_at":"2017-07-25T18:09:34.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"email":"katlyn7757869448929327@lind.co","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579/employees/7757869434229598","hippo_url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598"},"company":{"id":1404257697994579,"name":"Wisozk-Hermiston","email":"deanna7757869448866931@wisozk.org","salesforce_account_id":null,"work_states":["CA"],"sic_code":"4215","mailing_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"filing_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"benefits_address":{"id":7757727713727152,"street_1":"714 Junior Roads","street_2":"Suite 395","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94105","country":"USA","phone":"2968875378","created_at":"2017-01-05T14:56:00.000-08:00","updated_at":"2017-01-11T14:29:19.000-08:00","fax":"5622226496","inactive":false,"work_address":true,"employee_count":19},"number_of_eligible_ees":8,"number_of_ineligible_ees":11,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1404257697994579","hippo_url":"http://localhost:4001/companies/1404257697994579"},"state_carriers":[{"id":22,"name":"Guardian","state":"CA","key":"guardian_ca","url":"http://localhost:4001/national_carriers/24/state_carriers/22"},{"id":1,"name":"Anthem Blue Cross of California","state":"CA","key":"anthem_ca","url":"http://localhost:4001/national_carriers/4/state_carriers/1"}],"subscriptions":[{"id":58499,"policy_id":7179,"benefit_type":"vision","subscriber_id":"46352272","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869434229598,"dependent_ids":[4644,9846],"state_carrier_id":22,"url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598/subscriptions/58499"},{"id":58498,"policy_id":7178,"benefit_type":"dental","subscriber_id":"44920713","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869434229598,"dependent_ids":[4644,9846],"state_carrier_id":22,"url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598/subscriptions/58498"},{"id":58497,"policy_id":7176,"benefit_type":"medical","subscriber_id":"40333004","start_date":"2017-01-31","end_date":"2017-10-31","processed":true,"enrollment_id":28233,"employee_id":7757869434229598,"dependent_ids":[4644,9846],"state_carrier_id":1,"url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598/subscriptions/58497"}],"policies":[{"id":7179,"name":"Guardian EM Vision 12","benefit_type":"vision","group_number":"G-00532246","policy_number":null,"plan_id":1814,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":22,"url":"http://localhost:4001/companies/1404257697994579/policies/7179"},{"id":7178,"name":"Guardian EM Dental 13","benefit_type":"dental","group_number":"G-00532246","policy_number":null,"plan_id":1815,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":22,"url":"http://localhost:4001/companies/1404257697994579/policies/7178"},{"id":7176,"name":"Gold PPO 20/30%/5500","benefit_type":"medical","group_number":"J14947","policy_number":"J14947-1ZF9","plan_id":11,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":1,"url":"http://localhost:4001/companies/1404257697994579/policies/7176"}],"subscriptions_url":"http://localhost:4001/companies/1404257697994579/employees/7757869434229598/subscriptions"}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    @isTest
    static void testTwoPercentShareholder(){
        CaseTriggerHelper.skipTrigger = true;
        HIFulfillmentEventTriggerHelper.queue = true;
        
        test.startTest();
        HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
        objHiFulfilment.id__c = '111111111';
        objHiFulfilment.Processing_State__c='Queued';
        objHiFulfilment.Event_Type__c = 'employee_update';
        objHiFulfilment.Event_Info__c = '{"updates":[{"type":"two_percent_shareholder","previous":{"two_percent_shareholder":false},"current":{"two_percent_shareholder": true}}],"updated_at": "2021-02-20","employee": {"id": 7757869431528940,"first_name": "T","last_name": "Paine","middle_initial": "","status": "Active","ssn": "111111111","birthday": "1973-09-09","company_id": 7757616923580839,"hired_at": "2020-11-15","employment_status": "full_time","home_address": {"fax": null,"zip": "06405","city": "Branford","phone": null,"state": "CT","country": "USA","inactive": false,"street_1": "94 Ave","street_2": "","created_at": "2020-11-23T11:05:48.000-08:00","updated_at": "2020-11-23T11:05:48.000-08:00","county_name": "New Haven","work_address": false},"work_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45.000-07:00","updated_at": "2020-09-22T19:31:45.000-07:00","county_name": "New Haven","work_address": true,"effective_from": "2020-11-15","employee_count": 12},"email": "tpaine@hhhcenter.com.invalid","gender": "female","annual_salary": "60000.0","benefits_eligibility_date": "2020-11-15","panda_url": "https://app.gusto.com/panda/companies/7757616923580839/employees/7757869431528940","hippo_url": "https://hippo.gusto.com/companies/7757616923580839/employees/7757869431528940"},"company": {"id": 7757616923580839,"name": "Holistic Health \u0026 Healing Center LLC","email": "tpaine@hhhcenter.com.invalid","salesforce_account_id": null,"work_states": ["CT"],"sic_code": "8099","mailing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"filing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Thompson Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"benefits_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"number_of_eligible_ees": 7,"number_of_ineligible_ees": 8,"has_federal_cobra": false,"is_suspended": false,"panda_url": "https://app.gusto.com/panda/companies/7757616923580839","hippo_url": "https://hippo.gusto.com/companies/7757616923580839","google_drive_folder_url": "https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id": 1420,"name": "Guardian","state": "CT","key": "guardian_ct","url": "https://hippo.gusto.com/national_carriers/24/state_carriers/1420"}],"benefit_items": [{"id": 2269262,"policy_id": 282051,"benefit_type": "life","subscriber_id": null,"processing_status": "processed","start_date": "2021-01-01","end_date": "2021-12-31","enrollment_id": 997960,"employee_id": 7757869431528940,"dependent_ids": [],"state_carrier_id": 1420,"url": "https://hippo.gusto.com/companies/7757616923580839/employees/7757869431528940/selections/2269262"}],"policies": [{"id": 282051,"name": "Guardian EM Life 1F - CT","benefit_type": "life","group_number": "00583863","policy_number": null,"plan_id": 30542,"visible": true,"termination_policy": "last_day_of_employment","state_carrier_id": 1420,"carrier_plan_ids": "","url": "https://hippo.gusto.com/companies/7757616923580839/policies/282051"}],"forms": [],"benefits_url": "https://hippo.gusto.com/companies/7757616923580839/employees/7757869431528940/benefits","sent_at": "2021-02-20T13:50:04.281-08:00"}';
        insert objHiFulfilment;
        test.stopTest();
        
        System.assert([SELECT Id, Processing_State__c FROM HI_Fulfillment_Event__c].Processing_State__c == IntegrationUtils.PROCESSED_STATE);
    }

    /*
		Author      : Bhagat Singh
		Date        : 13 June 2022
		Description : Update member_updates tags in BOT JSON : Postive Case
		@Return     : N/A
    */
    @isTest
	static void updateOpenNHECaseBOTJSON() {
		Test.startTest();
		Utils.skipTrigger(true);
		Account objAccount = new TestDataFactory.AccountBuilder().setName('Test Account 01').setRecordTypeId(AccountUtil.COMPANY_ACCOUNT_RT_ID).setZPCompanyId('7757616923580730').build();
		insert objAccount;
		Contact objContact = new TestDataFactory.ContactBuilder()
			.setRecordTypeId('Company')
			.setFirstName('Test')
			.setLastName('User 01')
			.setAccountId(objAccount.Id)
			.setEmployeeId('6557869431520320')
			.setEmail('testuser01@gmail.com')
			.build();
		insert objContact;
		Carrier__c objCarrier = new TestDataFactory.CarrierBuilder().setUniqueName('united_healthcare_ny').setName('UnitedHealthcare').setState('NY').setCarrierId('94').build();
        objCarrier.key__c = 'united_healthcare_ny';
		insert objCarrier;

		Case objCase = new TestDataFactory.CaseBuilder()
			.setRecordTypeId('MF NHE')
			.setAccountId(objAccount.Id)
			.setContactId(objContact.Id)
			.setSubject('Test Case 1 Subject')
			.setDescription('Test Case 1 Description')
			.setType('NHE')
			.setStatus('New')
			.setIntegrationId('1110001123')
			.setIntegrationKey('1110001123-united_healthcare_ny')
			.build();
        objCase.Carrier__c = objCarrier.Id;
		insert objCase;

		Utils.skipTrigger(false);

		HIFulfillmentEventTriggerHelper.queue = true;
		HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
		objHiFulfilment.id__c = '11111111123';
		objHiFulfilment.Processing_State__c = 'Queued';
		objHiFulfilment.Company_id__c = '7757616923580730';
		objHiFulfilment.Employee_id__c = '6557869431520320';
		objHiFulfilment.Event_Type__c = 'employee_update';
		objHiFulfilment.Event_Info__c = '{"updates":[{"type":"birthday","previous":{"birthday":"2006-01-01"},"current":{"birthday":"2015-08-30"}}],"updated_at": "2021-02-20","employee": {"id": 6557869431520320,"first_name": "T","last_name": "Paine","middle_initial": "","status": "Active","ssn": "111111111","birthday": "1973-09-09","company_id": 7757616923580730,"hired_at": "2020-11-15","employment_status": "full_time","home_address": {"fax": null,"zip": "06405","city": "Branford","phone": null,"state": "CT","country": "USA","inactive": false,"street_1": "94 Ave","street_2": "","created_at": "2020-11-23T11:05:48.000-08:00","updated_at": "2020-11-23T11:05:48.000-08:00","county_name": "New Haven","work_address": false},"work_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45.000-07:00","updated_at": "2020-09-22T19:31:45.000-07:00","county_name": "New Haven","work_address": true,"effective_from": "2020-11-15","employee_count": 12},"email": "testuser01@gmail.com","gender": "female","annual_salary": "60000.0","benefits_eligibility_date": "2020-11-15","panda_url": "https://app.gusto.com/panda/companies/7757616923580730/employees/6557869431520320","hippo_url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320"},"company": {"id": 7757616923580730,"name": "Holistic Health \u0026 Healing Center LLC","email": "testuser01@gmail.com","salesforce_account_id": null,"work_states": ["CT"],"sic_code": "8099","mailing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"filing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Thompson Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"benefits_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"number_of_eligible_ees": 7,"number_of_ineligible_ees": 8,"has_federal_cobra": false,"is_suspended": false,"panda_url": "https://app.gusto.com/panda/companies/7757616923580730","hippo_url": "https://hippo.gusto.com/companies/7757616923580730","google_drive_folder_url": "https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id":94,"name":"UnitedHealthcare","state":"NY","key":"united_healthcare_ny","url":"https://hippo.gusto.com/national_carriers/60/state_carriers/94"}],"benefit_items": [{"id": 2269262,"policy_id": 282051,"benefit_type": "life","subscriber_id": null,"processing_status": "processed","start_date": "2021-01-01","end_date": "2021-12-31","enrollment_id": 997960,"employee_id": 6557869431520320,"dependent_ids": [],"state_carrier_id": 1420,"url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/selections/2269262"}],"policies": [{"id": 282051,"name": "Guardian EM Life 1F - CT","benefit_type": "life","group_number": "00583863","policy_number": null,"plan_id": 30542,"visible": true,"termination_policy": "last_day_of_employment","state_carrier_id": 1420,"carrier_plan_ids": "","url": "https://hippo.gusto.com/companies/7757616923580730/policies/282051"}],"forms": [],"benefits_url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/benefits","sent_at": "2021-02-20T13:50:04.281-08:00"}';
		insert objHiFulfilment;

		Test.stopTest();

		System.assert([SELECT Id, Fulfillment_Event_Encrypted_JSON__c FROM Case WHERE Id = :objCase.Id].Fulfillment_Event_Encrypted_JSON__c != null);
	}

	/*
		Author      : Bhagat Singh
		Date        : 13 June 2022
		Description : Update member_updates tags in BOT JSON : Negative Case
		@Return     : N/A
    */
    @isTest
	static void updateOpenNHECaseBOTJSONNC() {
		Test.startTest();
		Utils.skipTrigger(true);
		Account objAccount = new TestDataFactory.AccountBuilder().setName('Test Account 01').setRecordTypeId(AccountUtil.COMPANY_ACCOUNT_RT_ID).setZPCompanyId('7757616923580730').build();
		insert objAccount;
		Contact objContact = new TestDataFactory.ContactBuilder()
			.setRecordTypeId('Company')
			.setFirstName('Test')
			.setLastName('User 01')
			.setAccountId(objAccount.Id)
			.setEmployeeId('6557869431520320')
			.setEmail('testuser01@gmail.com')
			.build();
		insert objContact;
		Carrier__c objCarrier = new TestDataFactory.CarrierBuilder().setUniqueName('united_healthcare_ny').setName('UnitedHealthcare').setState('NY').setCarrierId('94').build();
        objCarrier.key__c = 'united_healthcare_ny';
		insert objCarrier;

		Case objCase = new TestDataFactory.CaseBuilder()
			.setRecordTypeId('MF NHE')
			.setAccountId(objAccount.Id)
			.setContactId(objContact.Id)
			.setSubject('Test Case 1 Subject')
			.setDescription('Test Case 1 Description')
			.setType('NHE')
			.setStatus('Closed')
			.setIntegrationId('1110001123')
			.setIntegrationKey('1110001123-united_healthcare_ny')
			.build();
        objCase.Carrier__c = objCarrier.Id;
		insert objCase;

		Utils.skipTrigger(false);

		HIFulfillmentEventTriggerHelper.queue = true;
		HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
		objHiFulfilment.id__c = '11111111123';
		objHiFulfilment.Processing_State__c = 'Queued';
		objHiFulfilment.Company_id__c = '7757616923580730';
		objHiFulfilment.Employee_id__c = '6557869431520320';
		objHiFulfilment.Event_Type__c = 'employee_update';
		objHiFulfilment.Event_Info__c = '{"updates":[{"type":"birthday","previous":{"birthday":"2006-01-01"},"current":{"birthday":"2015-08-30"}}],"updated_at": "2021-02-20","employee": {"id": 6557869431520320,"first_name": "T","last_name": "Paine","middle_initial": "","status": "Active","ssn": "111111111","birthday": "1973-09-09","company_id": 7757616923580730,"hired_at": "2020-11-15","employment_status": "full_time","home_address": {"fax": null,"zip": "06405","city": "Branford","phone": null,"state": "CT","country": "USA","inactive": false,"street_1": "94 Ave","street_2": "","created_at": "2020-11-23T11:05:48.000-08:00","updated_at": "2020-11-23T11:05:48.000-08:00","county_name": "New Haven","work_address": false},"work_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45.000-07:00","updated_at": "2020-09-22T19:31:45.000-07:00","county_name": "New Haven","work_address": true,"effective_from": "2020-11-15","employee_count": 12},"email": "testuser01@gmail.com","gender": "female","annual_salary": "60000.0","benefits_eligibility_date": "2020-11-15","panda_url": "https://app.gusto.com/panda/companies/7757616923580730/employees/6557869431520320","hippo_url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320"},"company": {"id": 7757616923580730,"name": "Holistic Health \u0026 Healing Center LLC","email": "testuser01@gmail.com","salesforce_account_id": null,"work_states": ["CT"],"sic_code": "8099","mailing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"filing_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64 Thompson Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"benefits_address": {"id": 7757869456693075,"fax": null,"zip": "06513","city": "East Haven","phone": "2036911685","state": "CT","country": "USA","inactive": false,"street_1": "64  Street","street_2": "A 103-104","created_at": "2020-09-22T19:31:45-07:00","updated_at": "2020-09-22T19:31:45-07:00","county_name": "New Haven","work_address": true,"employee_count": 11},"number_of_eligible_ees": 7,"number_of_ineligible_ees": 8,"has_federal_cobra": false,"is_suspended": false,"panda_url": "https://app.gusto.com/panda/companies/7757616923580730","hippo_url": "https://hippo.gusto.com/companies/7757616923580730","google_drive_folder_url": "https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id":94,"name":"UnitedHealthcare","state":"NY","key":"united_healthcare_ny","url":"https://hippo.gusto.com/national_carriers/60/state_carriers/94"}],"benefit_items": [{"id": 2269262,"policy_id": 282051,"benefit_type": "life","subscriber_id": null,"processing_status": "processed","start_date": "2021-01-01","end_date": "2021-12-31","enrollment_id": 997960,"employee_id": 6557869431520320,"dependent_ids": [],"state_carrier_id": 1420,"url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/selections/2269262"}],"policies": [{"id": 282051,"name": "Guardian EM Life 1F - CT","benefit_type": "life","group_number": "00583863","policy_number": null,"plan_id": 30542,"visible": true,"termination_policy": "last_day_of_employment","state_carrier_id": 1420,"carrier_plan_ids": "","url": "https://hippo.gusto.com/companies/7757616923580730/policies/282051"}],"forms": [],"benefits_url": "https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/benefits","sent_at": "2021-02-20T13:50:04.281-08:00"}';
		insert objHiFulfilment;

		Test.stopTest();

		System.assert([SELECT Id, Fulfillment_Event_Encrypted_JSON__c FROM Case WHERE Id = :objCase.Id].Fulfillment_Event_Encrypted_JSON__c == null);
	}

	/**
	* @description To make sure, system is able to set member_level_event_uuids from HI Fulfillment Event JSON member_level_events
	* @author Nigam Goyal | 07-17-2024 
	**/
    @isTest
	static void testMemberLevelEventUUIDS() {
		Test.startTest();
		Utils.skipTrigger(true);
		Account objAccount = new TestDataFactory.AccountBuilder().setName('Test Account 01').setRecordTypeId(AccountUtil.COMPANY_ACCOUNT_RT_ID).setZPCompanyId('7757616923580730').build();
		insert objAccount;
		Contact objContact = new TestDataFactory.ContactBuilder()
			.setRecordTypeId('Company')
			.setFirstName('Test')
			.setLastName('User 01')
			.setAccountId(objAccount.Id)
			.setEmployeeId('6557869431520320')
			.setEmail('testuser01@gmail.com')
			.build();
		insert objContact;
		Carrier__c objCarrier = new TestDataFactory.CarrierBuilder().setUniqueName('united_healthcare_ny').setName('UnitedHealthcare').setState('NY').setCarrierId('94').build();
        objCarrier.key__c = 'united_healthcare_ny';
		insert objCarrier;

		Utils.skipTrigger(false);

		HIFulfillmentEventTriggerHelper.queue = true;
		HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
		objHiFulfilment.id__c = '11111111123';
		objHiFulfilment.Processing_State__c = 'Queued';
		objHiFulfilment.Company_id__c = '7757616923580730';
		objHiFulfilment.Employee_id__c = '6557869431520320';
		objHiFulfilment.Event_Type__c = 'employee_update';
		objHiFulfilment.Event_Info__c = '{"updates":[{"type":"birthday","previous":{"birthday":"2006-01-01"},"current":{"birthday":"2015-08-30"}}],"updated_at":"2021-02-20","employee":{"id":6557869431520320,"first_name":"T","last_name":"Paine","middle_initial":"","status":"Active","ssn":"111111111","birthday":"1973-09-09","company_id":7757616923580730,"hired_at":"2020-11-15","employment_status":"full_time","home_address":{"fax":null,"zip":"06405","city":"Branford","phone":null,"state":"CT","country":"USA","inactive":false,"street_1":"94 Ave","street_2":"","created_at":"2020-11-23T11:05:48.000-08:00","updated_at":"2020-11-23T11:05:48.000-08:00","county_name":"New Haven","work_address":false},"work_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45.000-07:00","updated_at":"2020-09-22T19:31:45.000-07:00","county_name":"New Haven","work_address":true,"effective_from":"2020-11-15","employee_count":12},"email":"testuser01@gmail.com","gender":"female","annual_salary":"60000.0","benefits_eligibility_date":"2020-11-15","panda_url":"https://app.gusto.com/panda/companies/7757616923580730/employees/6557869431520320","hippo_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320"},"company":{"id":7757616923580730,"name":"Holistic Health & Healing Center LLC","email":"testuser01@gmail.com","salesforce_account_id":null,"work_states":["CT"],"sic_code":"8099","mailing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"filing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Thompson Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"benefits_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"number_of_eligible_ees":7,"number_of_ineligible_ees":8,"has_federal_cobra":false,"is_suspended":false,"panda_url":"https://app.gusto.com/panda/companies/7757616923580730","hippo_url":"https://hippo.gusto.com/companies/7757616923580730","google_drive_folder_url":"https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id":94,"name":"UnitedHealthcare","state":"NY","key":"united_healthcare_ny","url":"https://hippo.gusto.com/national_carriers/60/state_carriers/94"}],"member_level_events":[{"uuid":"057ba234-641c-4803-af97-86d2ff92af87","carrier_key":"united_healthcare_ny","carrier_Id":94},{"uuid":"8302947aslkfhaslfshalkfhaslk","carrier_key":"united_healthcare_ny","carrier_Id":94}],"benefit_items":[{"id":2269262,"policy_id":282051,"benefit_type":"life","subscriber_id":null,"processing_status":"processed","start_date":"2021-01-01","end_date":"2021-12-31","enrollment_id":997960,"employee_id":6557869431520320,"dependent_ids":[],"state_carrier_id":1420,"url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/selections/2269262"}],"policies":[{"id":282051,"name":"Guardian EM Life 1F - CT","benefit_type":"life","group_number":"00583863","policy_number":null,"plan_id":30542,"visible":true,"termination_policy":"last_day_of_employment","state_carrier_id":1420,"carrier_plan_ids":"","url":"https://hippo.gusto.com/companies/7757616923580730/policies/282051"}],"forms":[],"benefits_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/benefits","sent_at":"2021-02-20T13:50:04.281-08:00"}';
        insert objHiFulfilment;

		Test.stopTest();
        Case objCaseResult = [SELECT Id, Integration_Key__c, Integration_Id__c, Fulfillment_Event_Encrypted_JSON__c FROM Case];
        Blob decryptedBlob = EncodingUtil.base64Decode(objCaseResult.Fulfillment_Event_Encrypted_JSON__c);
        Blob encryptionKey = EncryptionUtils.getEncryptionKey('Master');
        String deCryptedText = EncryptionUtils.getDecryptedText(encryptionKey,decryptedBlob);
        HIFulfillmentBotResponseJSON objBotJson = new HIFulfillmentBotResponseJSON();
        objBotJson = (HIFulfillmentBotResponseJSON)JSON.deserialize(deCryptedText, HIFulfillmentBotResponseJSON.class);
        system.assertEquals('057ba234-641c-4803-af97-86d2ff92af87,8302947aslkfhaslfshalkfhaslk', objBotJson.member_level_event_uuids, 'member_level_event_uuids does not match');
	}

	/**
	* @description To make sure, system is able to concat member_level_event_uuids from HI Fulfillment Event JSON member_level_events
	* @author Nigam Goyal | 07-17-2024 
	**/
    @isTest
	static void testMemberLevelEventUUIDSWithMutpleUpdates() {
		Test.startTest();
		Utils.skipTrigger(true);
		Account objAccount = new TestDataFactory.AccountBuilder().setName('Test Account 01').setRecordTypeId(AccountUtil.COMPANY_ACCOUNT_RT_ID).setZPCompanyId('7757616923580730').build();
		insert objAccount;
		Contact objContact = new TestDataFactory.ContactBuilder()
			.setRecordTypeId('Company')
			.setFirstName('Test')
			.setLastName('User 01')
			.setAccountId(objAccount.Id)
			.setEmployeeId('6557869431520320')
			.setEmail('testuser01@gmail.com')
			.build();
		insert objContact;
		Carrier__c objCarrier = new TestDataFactory.CarrierBuilder().setUniqueName('united_healthcare_ny').setName('UnitedHealthcare').setState('NY').setCarrierId('94').build();
        objCarrier.key__c = 'united_healthcare_ny';
		insert objCarrier;

		Utils.skipTrigger(false);

		HIFulfillmentEventTriggerHelper.queue = true;
		HI_Fulfillment_Event__c objHiFulfilment = new HI_Fulfillment_Event__c();
		objHiFulfilment.id__c = '11111111123';
		objHiFulfilment.Processing_State__c = 'Queued';
		objHiFulfilment.Company_id__c = '7757616923580730';
		objHiFulfilment.Employee_id__c = '6557869431520320';
		objHiFulfilment.Event_Type__c = 'employee_update';
		objHiFulfilment.Event_Info__c = '{"updates":[{"type":"birthday","previous":{"birthday":"2006-01-01"},"current":{"birthday":"2015-08-30"}}],"updated_at":"2021-02-20","employee":{"id":6557869431520320,"first_name":"T","last_name":"Paine","middle_initial":"","status":"Active","ssn":"111111111","birthday":"1973-09-09","company_id":7757616923580730,"hired_at":"2020-11-15","employment_status":"full_time","home_address":{"fax":null,"zip":"06405","city":"Branford","phone":null,"state":"CT","country":"USA","inactive":false,"street_1":"94 Ave","street_2":"","created_at":"2020-11-23T11:05:48.000-08:00","updated_at":"2020-11-23T11:05:48.000-08:00","county_name":"New Haven","work_address":false},"work_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45.000-07:00","updated_at":"2020-09-22T19:31:45.000-07:00","county_name":"New Haven","work_address":true,"effective_from":"2020-11-15","employee_count":12},"email":"testuser01@gmail.com","gender":"female","annual_salary":"60000.0","benefits_eligibility_date":"2020-11-15","panda_url":"https://app.gusto.com/panda/companies/7757616923580730/employees/6557869431520320","hippo_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320"},"company":{"id":7757616923580730,"name":"Holistic Health & Healing Center LLC","email":"testuser01@gmail.com","salesforce_account_id":null,"work_states":["CT"],"sic_code":"8099","mailing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"filing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Thompson Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"benefits_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"number_of_eligible_ees":7,"number_of_ineligible_ees":8,"has_federal_cobra":false,"is_suspended":false,"panda_url":"https://app.gusto.com/panda/companies/7757616923580730","hippo_url":"https://hippo.gusto.com/companies/7757616923580730","google_drive_folder_url":"https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id":94,"name":"UnitedHealthcare","state":"NY","key":"united_healthcare_ny","url":"https://hippo.gusto.com/national_carriers/60/state_carriers/94"}],"member_level_events":[{"uuid":"057ba234-641c-4803-af97-86d2ff92af87","carrier_key":"united_healthcare_ny","carrier_Id":94},{"uuid":"8302947aslkfhaslfshalkfhaslk","carrier_key":"united_healthcare_ny","carrier_Id":94}],"benefit_items":[{"id":2269262,"policy_id":282051,"benefit_type":"life","subscriber_id":null,"processing_status":"processed","start_date":"2021-01-01","end_date":"2021-12-31","enrollment_id":997960,"employee_id":6557869431520320,"dependent_ids":[],"state_carrier_id":1420,"url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/selections/2269262"}],"policies":[{"id":282051,"name":"Guardian EM Life 1F - CT","benefit_type":"life","group_number":"00583863","policy_number":null,"plan_id":30542,"visible":true,"termination_policy":"last_day_of_employment","state_carrier_id":1420,"carrier_plan_ids":"","url":"https://hippo.gusto.com/companies/7757616923580730/policies/282051"}],"forms":[],"benefits_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/benefits","sent_at":"2021-02-20T13:50:04.281-08:00"}';
        insert objHiFulfilment;

        HIFulfillmentEventTriggerHelper.queue = true;
		HI_Fulfillment_Event__c objHiFulfilment1 = new HI_Fulfillment_Event__c();
		objHiFulfilment1.id__c = '11111111144';
		objHiFulfilment1.Processing_State__c = 'Queued';
		objHiFulfilment1.Company_id__c = '7757616923580730';
		objHiFulfilment1.Employee_id__c = '6557869431520320';
		objHiFulfilment1.Event_Type__c = 'employee_update';
		objHiFulfilment1.Event_Info__c = '{"updates":[{"type":"birthday","previous":{"birthday":"2006-01-01"},"current":{"birthday":"2015-08-30"}}],"updated_at":"2021-02-20","employee":{"id":6557869431520320,"first_name":"T","last_name":"Paine","middle_initial":"","status":"Active","ssn":"111111111","birthday":"1973-09-09","company_id":7757616923580730,"hired_at":"2020-11-15","employment_status":"full_time","home_address":{"fax":null,"zip":"06405","city":"Branford","phone":null,"state":"CT","country":"USA","inactive":false,"street_1":"94 Ave","street_2":"","created_at":"2020-11-23T11:05:48.000-08:00","updated_at":"2020-11-23T11:05:48.000-08:00","county_name":"New Haven","work_address":false},"work_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45.000-07:00","updated_at":"2020-09-22T19:31:45.000-07:00","county_name":"New Haven","work_address":true,"effective_from":"2020-11-15","employee_count":12},"email":"testuser01@gmail.com","gender":"female","annual_salary":"60000.0","benefits_eligibility_date":"2020-11-15","panda_url":"https://app.gusto.com/panda/companies/7757616923580730/employees/6557869431520320","hippo_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320"},"company":{"id":7757616923580730,"name":"Holistic Health & Healing Center LLC","email":"testuser01@gmail.com","salesforce_account_id":null,"work_states":["CT"],"sic_code":"8099","mailing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"filing_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64 Thompson Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"benefits_address":{"id":7757869456693075,"fax":null,"zip":"06513","city":"East Haven","phone":"2036911685","state":"CT","country":"USA","inactive":false,"street_1":"64  Street","street_2":"A 103-104","created_at":"2020-09-22T19:31:45-07:00","updated_at":"2020-09-22T19:31:45-07:00","county_name":"New Haven","work_address":true,"employee_count":11},"number_of_eligible_ees":7,"number_of_ineligible_ees":8,"has_federal_cobra":false,"is_suspended":false,"panda_url":"https://app.gusto.com/panda/companies/7757616923580730","hippo_url":"https://hippo.gusto.com/companies/7757616923580730","google_drive_folder_url":"https://drive.google.com/drive/folders/12wxy2Tp-P9eX4v4Def5Z12Baq7WdXz9z"},"state_carriers":[{"id":94,"name":"UnitedHealthcare","state":"NY","key":"united_healthcare_ny","url":"https://hippo.gusto.com/national_carriers/60/state_carriers/94"}],"member_level_events":[{"uuid":"057ba234-641c-4803-af97-86d2ff92af55","carrier_key":"united_healthcare_ny","carrier_Id":94},{"uuid":"8302947aslkfhaslfshalkfhaslk66","carrier_key":"united_healthcare_ny","carrier_Id":94}],"benefit_items":[{"id":2269262,"policy_id":282051,"benefit_type":"life","subscriber_id":null,"processing_status":"processed","start_date":"2021-01-01","end_date":"2021-12-31","enrollment_id":997960,"employee_id":6557869431520320,"dependent_ids":[],"state_carrier_id":1420,"url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/selections/2269262"}],"policies":[{"id":282051,"name":"Guardian EM Life 1F - CT","benefit_type":"life","group_number":"00583863","policy_number":null,"plan_id":30542,"visible":true,"termination_policy":"last_day_of_employment","state_carrier_id":1420,"carrier_plan_ids":"","url":"https://hippo.gusto.com/companies/7757616923580730/policies/282051"}],"forms":[],"benefits_url":"https://hippo.gusto.com/companies/7757616923580730/employees/6557869431520320/benefits","sent_at":"2021-02-20T13:50:04.281-08:00"}';
        insert objHiFulfilment1;

		Test.stopTest();
        List<Case> list_CaseResults = [SELECT Id, Integration_Key__c, Integration_Id__c, Fulfillment_Event_Encrypted_JSON__c FROM Case];
        for(Case CaseObj: list_CaseResults){
            Blob decryptedBlob = EncodingUtil.base64Decode(CaseObj.Fulfillment_Event_Encrypted_JSON__c);
            Blob encryptionKey = EncryptionUtils.getEncryptionKey('Master');
            String deCryptedText = EncryptionUtils.getDecryptedText(encryptionKey,decryptedBlob);
            HIFulfillmentBotResponseJSON objBotJson = new HIFulfillmentBotResponseJSON();
            objBotJson = (HIFulfillmentBotResponseJSON)JSON.deserialize(deCryptedText, HIFulfillmentBotResponseJSON.class);
            system.debug(CaseObj);
            system.debug(objBotJson.member_level_event_uuids);
        }
        Blob decryptedBlob = EncodingUtil.base64Decode(list_CaseResults[0].Fulfillment_Event_Encrypted_JSON__c);
        Blob encryptionKey = EncryptionUtils.getEncryptionKey('Master');
        String deCryptedText = EncryptionUtils.getDecryptedText(encryptionKey,decryptedBlob);
        HIFulfillmentBotResponseJSON objBotJson = new HIFulfillmentBotResponseJSON();
        objBotJson = (HIFulfillmentBotResponseJSON)JSON.deserialize(deCryptedText, HIFulfillmentBotResponseJSON.class);
        system.assertEquals('057ba234-641c-4803-af97-86d2ff92af87,8302947aslkfhaslfshalkfhaslk,057ba234-641c-4803-af97-86d2ff92af55,8302947aslkfhaslfshalkfhaslk66', objBotJson.member_level_event_uuids, 'member_level_event_uuids does not match');
    }
  
}