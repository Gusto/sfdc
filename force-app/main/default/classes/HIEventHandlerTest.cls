/**
  Author:        Robin Grover
  Company:       Gusto
  Description:   This is a test class for HiEventHandler 

  History
  7/5/2017    Robin Grover     Initial Implementation
  **/
@isTest
private class HIEventHandlerTest {

    static {
        Blob key = EncryptionUtils.generateKey('Master');
        Account testAcc = new Account(
            ZP_Company_ID__c = '7757616923505614',
            Name  = 'Test Account'
        );
        insert testAcc;

        Carrier__c testCarrier = new Carrier__c(
            Key__c = 'bcbs_ma',
            Name = 'Test Carrier',
            State__c = 'AL'
        );
        insert testCarrier;
    }
    static testMethod void createNewHIFulfillmentTermRecTest() {
      
        HIFulfillmentEventTriggerHelper.queue = true;
        
        String event_id = 'Test321';
        String event_type = 'employee_losing_eligibility';
        String event_info = '{"losing_benefits_date":"2017-07-27","losing_benefits_reason":"Termination","carrier_directory":"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132","employee":{"id":7757869431795591,"first_name":"Eileen","last_name":"Koepp","middle_initial":"","status":"Active","ssn":"123456789","birthday":"1981-08-14","company_id":1370368242490000,"hired_at":"2017-07-10","employment_status":"full_time","home_address":{"id":7757727714014570,"street_1":"6198 Elaina Inlet","street_2":"Suite 639","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94109","country":"USA","phone":null,"created_at":"2017-07-05T15:26:28.000-07:00","updated_at":"2017-07-05T15:26:28.000-07:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":1383002648546509,"street_1":"88464 Harmon Pine","street_2":"Suite 812","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94107","country":"USA","phone":"7944174714","created_at":"2013-10-28T16:24:08.000-07:00","updated_at":"2016-05-25T08:12:58.000-07:00","fax":"3587335331","inactive":false,"work_address":true,"employee_count":61},"email":"tamia7757869449269353@uptonreynolds.com","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/1370368242490000/employees/7757869431795591","hippo_url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591","payroll_type":"Exempt"},"company":{"id":1370368242490000,"name":"Homenick-Aufderhar","email":"hollie_haley7757869448810741@ernser.name","salesforce_account_id":null,"work_states":["CA"],"sic_code":"8999","mailing_address":{"id":1383002648546509,"street_1":"88464 Harmon Pine","street_2":"Suite 812","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94107","country":"USA","phone":"7944174714","created_at":"2013-10-28T16:24:08.000-07:00","updated_at":"2016-05-25T08:12:58.000-07:00","fax":"3587335331","inactive":false,"work_address":true,"employee_count":61},"filing_address":{"id":1383002648546509,"street_1":"88464 Harmon Pine","street_2":"Suite 812","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94107","country":"USA","phone":"7944174714","created_at":"2013-10-28T16:24:08.000-07:00","updated_at":"2016-05-25T08:12:58.000-07:00","fax":"3587335331","inactive":false,"work_address":true,"employee_count":61},"benefits_address":{"id":1383002648546509,"street_1":"88464 Harmon Pine","street_2":"Suite 812","city":"San Francisco","county_name":"San Francisco","state":"CA","zip":"94107","country":"USA","phone":"7944174714","created_at":"2013-10-28T16:24:08.000-07:00","updated_at":"2016-05-25T08:12:58.000-07:00","fax":"3587335331","inactive":false,"work_address":true,"employee_count":61},"number_of_eligible_ees":39,"number_of_ineligible_ees":2,"has_federal_cobra":true,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/1370368242490000","hippo_url":"http://localhost:4001/companies/1370368242490000"},"state_carriers":[{"id":22,"name":"Guardian","state":"CA","key":"guardian_ca","url":"http://localhost:4001/national_carriers/24/state_carriers/22","forms":[]},{"id":2,"name":"Blue Shield of California","state":"CA","key":"blue_shield_ca","url":"http://localhost:4001/national_carriers/8/state_carriers/2","forms":[]}],"subscriptions":[{"id":103300,"policy_id":3043,"benefit_type":"dental","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"dependent_ids":[],"state_carrier_id":22,"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103300","total_premium":58.36},{"id":103301,"policy_id":3044,"benefit_type":"vision","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"dependent_ids":[],"state_carrier_id":22,"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103301","total_premium":13.44},{"id":103298,"policy_id":8401,"benefit_type":"medical","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"dependent_ids":[],"state_carrier_id":2,"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103298","total_premium":742.56}],"policies":[{"id":3043,"name":"DentalGuard Preferred [Lob.com]","benefit_type":"dental","group_number":"501254","policy_number":null,"plan_id":163,"visible":true,"termination_policy":null,"state_carrier_id":22,"url":"http://localhost:4001/companies/1370368242490000/policies/3043"},{"id":3044,"name":"VSP Signature Full Feature [Lob.com]","benefit_type":"vision","group_number":"501254","policy_number":null,"plan_id":164,"visible":true,"termination_policy":null,"state_carrier_id":22,"url":"http://localhost:4001/companies/1370368242490000/policies/3044"},{"id":8401,"name":"Platinum Full PPO 0/10 OffEx","benefit_type":"medical","group_number":"W0076882","policy_number":null,"plan_id":952,"visible":true,"termination_policy":null,"state_carrier_id":2,"url":"http://localhost:4001/companies/1370368242490000/policies/8401"}],"dependents":[],"forms":[{"id": 1111,"name":"name","url":"url","encoded_form_data": "test"}],"alegeus":{"dca":{"subscriptions":[],"policies":[]},"fsa":{"subscriptions":[{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302"}],"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]},"hsa":{}},"subscriptions_url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions","dependents_url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/dependents","commuter_benefit":{"id":3,"company_id":1408063107892611,"status":"processed","start_date":"2017-09-01","end_date":null,"upcoming":false,"active":true,"expired":false,"waiting_period":"first_of_month_following_hire","company_contribution_inputs":{"type":"fixed_amount","parking_contribution_amount":"0","transit_contribution_amount":"255"},"url":"https://hippo.gusto.com/companies/1408063107892611/commuter_benefits/3"},"commuter_employee_benefit":{"id":4,"employee_id":7757869431686263,"commuter_benefit_id":3,"status":"processed","start_date":"2017-09-01","transit_monthly_election":"255.0","transit_monthly_contribution":"255.0","transit_monthly_deduction":"0.0","parking_monthly_election":"0.0","parking_monthly_contribution":"0.0","parking_monthly_deduction":"0.0","url":"https://hippo.gusto.com/companies/1408063107892611/employees/7757869431686263/commuter_employee_benefits/4","commuter_benefit_url":"https://hippo.gusto.com/companies/1408063107892611/commuter_benefits/3"}}';

        HiEventHandler.createNewCase(event_id, event_type, event_info,'','','');

        System.assertEquals(1,[Select count() from HI_Fulfillment_Event__c]);

    }
    static testMethod void createNewHIFulfillmentNHERecTest() {
      
        HIFulfillmentEventTriggerHelper.queue = true;
        
        String event_id = 'Test321';
        String event_type = 'enrollment_ready_for_processing';
        String event_info = '{"enrollment":{"id":47431,"employee_id":7757869431613363,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431"},"recent_qles":[{"id":1682,"event":"marriage","date_of_event":"2017-05-26","file_upload_urls":[],"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/qualifying_life_events/1682"}],"carrier_directory":"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132","employee":{"id":7757869431613363,"first_name":"Vincent","last_name":"Smitham","middle_initial":"M","status":"Active","ssn":"123456789","birthday":"1985-03-12","company_id":7757616923599114,"hired_at":"2014-05-12","employment_status":"full_time","home_address":{"id":7757727713689401,"street_1":"4349 Bradley Circles","street_2":"Suite 826","city":"Los Angeles","county_name":"Los Angeles","state":"CA","zip":"90027","country":"USA","phone":null,"created_at":"2016-12-14T14:36:45.000-08:00","updated_at":"2016-12-14T14:36:45.000-08:00","fax":null,"inactive":false,"work_address":false},"work_address":{"id":7757727713687976,"street_1":"427 OReilly Ramp","street_2":"Suite 475","city":"Los Angeles","county_name":"Los Angeles","state":"CA","zip":"90029","country":"USA","phone":"8899664872","created_at":"2016-12-13T17:35:24.000-08:00","updated_at":"2016-12-13T17:35:24.000-08:00","fax":null,"inactive":false,"work_address":true,"employee_count":6},"email":"schuyler.muller7757869449033705@turcottefisher.info","gender":"male","panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923599114/employees/7757869431613363","hippo_url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363"},"company":{"id":7757616923599114,"name":"Kihn, Cole and Turner","email":"justyn_dickens7757869449032810@bednar.com","salesforce_account_id":null,"work_states":["CA"],"sic_code":"6794","mailing_address":{"id":7757727713687976,"street_1":"427 OReilly Ramp","street_2":"Suite 475","city":"Los Angeles","county_name":"Los Angeles","state":"CA","zip":"90029","country":"USA","phone":"8899664872","created_at":"2016-12-13T17:35:24.000-08:00","updated_at":"2016-12-13T17:35:24.000-08:00","fax":null,"inactive":false,"work_address":true,"employee_count":6},"filing_address":{"id":7757727713687976,"street_1":"427 OReilly Ramp","street_2":"Suite 475","city":"Los Angeles","county_name":"Los Angeles","state":"CA","zip":"90029","country":"USA","phone":"8899664872","created_at":"2016-12-13T17:35:24.000-08:00","updated_at":"2016-12-13T17:35:24.000-08:00","fax":null,"inactive":false,"work_address":true,"employee_count":6},"benefits_address":{"id":7757727713687976,"street_1":"427 OReilly Ramp","street_2":"Suite 475","city":"Los Angeles","county_name":"Los Angeles","state":"CA","zip":"90029","country":"USA","phone":"8899664872","created_at":"2016-12-13T17:35:24.000-08:00","updated_at":"2016-12-13T17:35:24.000-08:00","fax":null,"inactive":false,"work_address":true,"employee_count":6},"number_of_eligible_ees":6,"number_of_ineligible_ees":0,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.zenpayroll.dev:3000/companies/7757616923599114","hippo_url":"http://localhost:4001/companies/7757616923599114"},"state_carriers":[{"id":24,"name":"Principal","state":"CA","key":"principal_ca","url":"http://localhost:4001/national_carriers/48/state_carriers/24","carrier_enrollment_url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/principal_ca","forms":[]},{"id":5,"name":"Kaiser Permanente","state":"CA","key":"kaiser_ca","url":"http://localhost:4001/national_carriers/36/state_carriers/5","carrier_enrollment_url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/kaiser_ca","forms":[88268]}],"benefit_items":{"dental":{"current":null,"overlapping":[{"id":53794,"policy_id":15619,"benefit_type":"dental","subscriber_id":"22270388","start_date":"2017-03-01","end_date":"2018-02-28","processed":true,"enrollment_id":25666,"employee_id":7757869431613363,"dependent_ids":[],"state_carrier_id":24,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53794"}],"previous":[]},"medical":{"current":{"id":98828,"policy_id":15841,"benefit_type":"medical","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":47431,"employee_id":7757869431613363,"dependent_ids":[16918],"state_carrier_id":5,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98828","estimated_start_date":"2017-05-26","estimated_total_premium":763.9,"estimated_employee_premium":375.63,"estimated_dependents_premium":388.27,"ops_owner":"member_fulfillment"},"overlapping":[{"id":53793,"policy_id":15842,"benefit_type":"medical","subscriber_id":"61306767","start_date":"2017-03-01","end_date":"2018-02-28","processed":true,"enrollment_id":25666,"employee_id":7757869431613363,"dependent_ids":[],"state_carrier_id":5,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53793"}],"previous":[]},"vision":{"current":{"id":98829,"policy_id":15634,"benefit_type":"vision","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":47431,"employee_id":7757869431613363,"dependent_ids":[16918],"state_carrier_id":24,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98829","estimated_start_date":"2017-05-26","estimated_total_premium":19.51,"estimated_employee_premium":9.68,"estimated_dependents_premium":9.83,"ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]}},"policies":[{"id":15619,"name":"Principal Dental Plan 4","benefit_type":"dental","group_number":"1073605-10001","policy_number":null,"plan_id":2224,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":24,"url":"http://localhost:4001/companies/7757616923599114/policies/15619"},{"id":15631,"name":"Silver 70 HMO 1000/50 + Child Dental Alt","benefit_type":"medical","group_number":"344089","policy_number":null,"plan_id":2419,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":5,"url":"http://localhost:4001/companies/7757616923599114/policies/15631"},{"id":15634,"name":"Principal Vision Plan 2","benefit_type":"vision","group_number":"","policy_number":null,"plan_id":1975,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":24,"url":"http://localhost:4001/companies/7757616923599114/policies/15634"},{"id":15841,"name":"Platinum 90 HMO 0/10 + Child Dental Alt","benefit_type":"medical","group_number":"","policy_number":null,"plan_id":2413,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":5,"url":"http://localhost:4001/companies/7757616923599114/policies/15841"},{"id":15842,"name":"Gold 80 HMO 0/30 w/ Child Dental, Acu","benefit_type":"medical","group_number":"","policy_number":null,"plan_id":2410,"visible":true,"termination_policy":"last_day_of_month_on_or_after_termination","state_carrier_id":5,"url":"http://localhost:4001/companies/7757616923599114/policies/15842"}],"dependents":[{"id":16918,"first_name":"Doug","last_name":"Wintheiser","ssn":"123456789","birthday":"1983-07-03","gender":"female","dependent_type":"spouse","employee_id":7757869431613363,"url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/dependents/16918"}],"forms":[{"id":88268,"name":"2017 Kaiser CA Employee Change Form","url":"http://localhost:4001/attachments/forms/88268", "encoded_form_data": "111"}],"answers":[],"alegeus":{"fsa":{"benefit_items":{"current":{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302","estimated_start_date":"2017-08-01","ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]},"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]}},"benefits_url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions","enrollments_url":"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments"}';

        HiEventHandler.createNewCase(event_id, event_type, event_info,'','','');

        System.assertEquals(1,[Select count() from HI_Fulfillment_Event__c]);

    }
    static testMethod void createNewHIFulfillmentAuditRecTest() {
      
        HIFulfillmentEventTriggerHelper.queue = true;
        
        String event_id = 'Test321';
        String event_type = 'audit';
        String event_info = '{"audit_type":"benefits_status_audit","subject":"benefits_status_audit_out_of_sync","items":[],"instructions":null,"company":{"id":7757616923594875,"name":"Jaskolski, Nicolas and Feil","email":"edyth.hills7757869448393078@marvin.net","salesforce_account_id":null,"work_states":["IL","MA","NY"],"sic_code":"3699","mailing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"filing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"benefits_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"number_of_eligible_ees":8,"number_of_ineligible_ees":7,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.gusto-dev.com:3000/companies/7757616923480535","hippo_url":"http://localhost:4001/companies/7757616923480535"},"employee":{"hippo_url":"http://localhost:4001/companies/7757616923480535"}}';
        
        HiEventHandler.createNewCase(event_id, event_type, event_info,'','','');

        System.assertEquals(1,[Select count() from HI_Fulfillment_Event__c]);

    }    
    
}