@isTest
private class HIFulfillmentEventBatchTest {
  @TestSetup
  static void makeData() {
    Blob key = EncryptionUtils.generateKey('Master');
    Utils.skipTrigger(true);

    Account objAccount = new TestDataFactory.AccountBuilder()
      .setRecordTypeId(Cache.getRecordTypeId('Account', 'Company'))
      .setZPCompanyId('7757616923594875')
      .setName('Test')
      .build();
    insert objAccount;

    insert new TestDataFactory.CarrierBuilder()
      .setName('Test Carrier')
      .setKey('bcbs_ma')
      .setState('AL')
      .setId('51')
      .build();

    Opportunity objOpportunity = new TestDataFactory.OpportunityBuilder()
      .setRecordTypeId(
        Cache.getRecordTypeId('Opportunity', 'Benefits New Plan')
      )
      .setName('Test')
      .setAccountId(objAccount.Id)
      .setStage('ER Confirm')
      .setCloseDate(Date.newInstance(2019, 7, 1))
      .setNumberOfEE(30)
      .setZPCompanyId('7757616923594875')
      .setSourceID('12121212121212')
      .build();
    objOpportunity.Renewal_Date__c = Date.newInstance(2030, 12, 31);
    objOpportunity.Benefits_Current_Setup_Step__c = 'Completed';
    insert objOpportunity;

    Benefit_Order__c objBenefitOrder = new TestDataFactory.BenefitOrderBuilder()
      .setRecordType(Cache.getRecordTypeId('Benefit_Order__c', 'New Plan'))
      .setName('Test Benefit Order')
      .setAccount(objAccount.Id)
      .setOpp(objOpportunity.Id)
      .setCoverageEffectiveDate(System.today())
      .setSubmissionDeadline(System.today())
      .setOwnerID(UserInfo.getUserId())
      .build();
    insert objBenefitOrder;
    Utils.skipTrigger(false);
  }

  /**
   * @author       Deepika Saini
   * @description  This method is used to test the reprocess the HI Fulfillment Event record when it is in Queue state.
   **/
  @isTest
  static void testFulfillmentEventBatchQueuedReprocess() {
    HI_Fulfillment_Event__c objHIFulfillmentEvent = new TestDataFactory.HIFulfillmentEventBuilder()
      .setId('Test321')
      .setEventType('enrollment_ready_for_processing')
      .setEventInfo(
        '{\"enrollment\":{\"id\":47431,\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431\"},\"recent_qles\":[{\"id\":1682,\"event\":\"marriage\",\"date_of_event\":\"2017-05-26\",\"file_upload_urls\":[],\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/qualifying_life_events/1682\"}],\"carrier_directory\":\"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132\",\"employee\":{\"id\":7757869431613363,\"first_name\":\"Vincent\",\"last_name\":\"Smitham\",\"middle_initial\":\"M\",\"status\":\"Active\",\"ssn\":\"123456789\",\"birthday\":\"1985-03-12\",\"company_id\":7757616923594875,\"hired_at\":\"2014-05-12\",\"employment_status\":\"full_time\",\"home_address\":{\"id\":7757727713689401,\"street_1\":\"4349 Bradley Circles\",\"street_2\":\"Suite 826\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90027\",\"country\":\"USA\",\"phone\":null,\"created_at\":\"2016-12-14T14:36:45.000-08:00\",\"updated_at\":\"2016-12-14T14:36:45.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":false},\"work_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"email\":\"schuyler.muller7757869449033705@turcottefisher.info\",\"gender\":\"male\",\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114/employees/7757869431613363\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363\"},\"company\":{\"id\":7757616923594875,\"name\":\"Kihn, Cole and Turner\",\"email\":\"justyn_dickens7757869449032810@bednar.com\",\"salesforce_account_id\":null,\"work_states\":[\"CA\"],\"sic_code\":\"6794\",\"mailing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"filing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"benefits_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"number_of_eligible_ees\":6,\"number_of_ineligible_ees\":0,\"has_federal_cobra\":null,\"is_suspended\":false,\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114\"},\"state_carriers\":[{\"id\":24,\"name\":\"Principal\",\"state\":\"CA\",\"key\":\"principal_ca\",\"url\":\"http://localhost:4001/national_carriers/48/state_carriers/24\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/principal_ca\",\"forms\":[]},{\"id\":5,\"name\":\"Kaiser Permanente\",\"state\":\"CA\",\"key\":\"kaiser_ca\",\"url\":\"http://localhost:4001/national_carriers/36/state_carriers/5\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/kaiser_ca\",\"forms\":[88268]}],\"benefit_items\":{\"dental\":{\"current\":null,\"overlapping\":[{\"id\":53794,\"policy_id\":15619,\"benefit_type\":\"dental\",\"subscriber_id\":\"22270388\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53794\"}],\"previous\":[]},\"medical\":{\"current\":{\"id\":98828,\"policy_id\":15841,\"benefit_type\":\"medical\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98828\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":763.9,\"estimated_employee_premium\":375.63,\"estimated_dependents_premium\":388.27,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[{\"id\":53793,\"policy_id\":15842,\"benefit_type\":\"medical\",\"subscriber_id\":\"61306767\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53793\"}],\"previous\":[]},\"vision\":{\"current\":{\"id\":98829,\"policy_id\":15634,\"benefit_type\":\"vision\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98829\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":19.51,\"estimated_employee_premium\":9.68,\"estimated_dependents_premium\":9.83,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[],\"previous\":[]}},\"policies\":[{\"id\":15619,\"name\":\"Principal Dental Plan 4\",\"benefit_type\":\"dental\",\"group_number\":\"1073605-10001\",\"policy_number\":null,\"plan_id\":2224,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15619\"},{\"id\":15631,\"name\":\"Silver 70 HMO 1000/50 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"344089\",\"policy_number\":null,\"plan_id\":2419,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15631\"},{\"id\":15634,\"name\":\"Principal Vision Plan 2\",\"benefit_type\":\"vision\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":1975,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15634\"},{\"id\":15841,\"name\":\"Platinum 90 HMO 0/10 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2413,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15841\"},{\"id\":15842,\"name\":\"Gold 80 HMO 0/30 w/ Child Dental, Acu\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2410,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15842\"}],\"dependents\":[{\"id\":16918,\"first_name\":\"Doug\",\"last_name\":\"Wintheiser\",\"ssn\":\"123456789\",\"birthday\":\"1983-07-03\",\"gender\":\"female\",\"dependent_type\":\"spouse\",\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/dependents/16918\"}],\"forms\":[{\"id\":88268,\"name\":\"2017 Kaiser CA Employee Change Form\",\"url\":\"http://localhost:4001/attachments/forms/88268\"}],\"answers\":[],"alegeus":{"fsa":{"benefit_items":{"current":{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302","estimated_start_date":"2017-08-01","ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]},"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]}},\"benefits_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions\",\"enrollments_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments\"}'
      )
      .build();
    insert objHIFulfillmentEvent;

    Test.startTest();
    Database.executeBatch(new HIFulfillmentEventBatch(), 10);
    Test.stopTest();
  }

  /**
   * @author      Udit Jain
   * @description  This method is used to test the reprocess the HI Fulfillment Event record when it has been in 'Error' state,
   * 				 reprocess it every 2nd hour based on Processed At.
   **/
  @isTest
  static void testFulfillmentEventBatchErrorReprocess() {
    HIFulfillmentEventTriggerHelper.queue = true;
    HI_Fulfillment_Event__c objHIFulfillmentEvent = new TestDataFactory.HIFulfillmentEventBuilder()
      .setId('Test321')
      .setEventType('enrollment_ready_for_processing')
      .setEventInfo(
        '{\"enrollment\":{\"id\":47431,\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431\"},\"recent_qles\":[{\"id\":1682,\"event\":\"marriage\",\"date_of_event\":\"2017-05-26\",\"file_upload_urls\":[],\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/qualifying_life_events/1682\"}],\"carrier_directory\":\"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132\",\"employee\":{\"id\":7757869431613363,\"first_name\":\"Vincent\",\"last_name\":\"Smitham\",\"middle_initial\":\"M\",\"status\":\"Active\",\"ssn\":\"123456789\",\"birthday\":\"1985-03-12\",\"company_id\":111111,\"hired_at\":\"2014-05-12\",\"employment_status\":\"full_time\",\"home_address\":{\"id\":7757727713689401,\"street_1\":\"4349 Bradley Circles\",\"street_2\":\"Suite 826\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90027\",\"country\":\"USA\",\"phone\":null,\"created_at\":\"2016-12-14T14:36:45.000-08:00\",\"updated_at\":\"2016-12-14T14:36:45.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":false},\"work_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"email\":\"schuyler.muller7757869449033705@turcottefisher.info\",\"gender\":\"male\",\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114/employees/7757869431613363\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363\"},\"company\":{\"id\":111111,\"name\":\"Kihn, Cole and Turner\",\"email\":\"justyn_dickens7757869449032810@bednar.com\",\"salesforce_account_id\":null,\"work_states\":[\"CA\"],\"sic_code\":\"6794\",\"mailing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"filing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"benefits_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"number_of_eligible_ees\":6,\"number_of_ineligible_ees\":0,\"has_federal_cobra\":null,\"is_suspended\":false,\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114\"},\"state_carriers\":[{\"id\":24,\"name\":\"Principal\",\"state\":\"CA\",\"key\":\"principal_ca\",\"url\":\"http://localhost:4001/national_carriers/48/state_carriers/24\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/principal_ca\",\"forms\":[]},{\"id\":5,\"name\":\"Kaiser Permanente\",\"state\":\"CA\",\"key\":\"kaiser_ca\",\"url\":\"http://localhost:4001/national_carriers/36/state_carriers/5\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/kaiser_ca\",\"forms\":[88268]}],\"benefit_items\":{\"dental\":{\"current\":null,\"overlapping\":[{\"id\":53794,\"policy_id\":15619,\"benefit_type\":\"dental\",\"subscriber_id\":\"22270388\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53794\"}],\"previous\":[]},\"medical\":{\"current\":{\"id\":98828,\"policy_id\":15841,\"benefit_type\":\"medical\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98828\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":763.9,\"estimated_employee_premium\":375.63,\"estimated_dependents_premium\":388.27,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[{\"id\":53793,\"policy_id\":15842,\"benefit_type\":\"medical\",\"subscriber_id\":\"61306767\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53793\"}],\"previous\":[]},\"vision\":{\"current\":{\"id\":98829,\"policy_id\":15634,\"benefit_type\":\"vision\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98829\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":19.51,\"estimated_employee_premium\":9.68,\"estimated_dependents_premium\":9.83,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[],\"previous\":[]}},\"policies\":[{\"id\":15619,\"name\":\"Principal Dental Plan 4\",\"benefit_type\":\"dental\",\"group_number\":\"1073605-10001\",\"policy_number\":null,\"plan_id\":2224,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15619\"},{\"id\":15631,\"name\":\"Silver 70 HMO 1000/50 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"344089\",\"policy_number\":null,\"plan_id\":2419,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15631\"},{\"id\":15634,\"name\":\"Principal Vision Plan 2\",\"benefit_type\":\"vision\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":1975,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15634\"},{\"id\":15841,\"name\":\"Platinum 90 HMO 0/10 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2413,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15841\"},{\"id\":15842,\"name\":\"Gold 80 HMO 0/30 w/ Child Dental, Acu\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2410,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15842\"}],\"dependents\":[{\"id\":16918,\"first_name\":\"Doug\",\"last_name\":\"Wintheiser\",\"ssn\":\"123456789\",\"birthday\":\"1983-07-03\",\"gender\":\"female\",\"dependent_type\":\"spouse\",\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/dependents/16918\"}],\"forms\":[{\"id\":88268,\"name\":\"2017 Kaiser CA Employee Change Form\",\"url\":\"http://localhost:4001/attachments/forms/88268\"}],\"answers\":[],"alegeus":{"fsa":{"benefit_items":{"current":{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302","estimated_start_date":"2017-08-01","ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]},"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]}},\"benefits_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions\",\"enrollments_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments\"}'
      )
      .build();
    insert objHIFulfillmentEvent;

    HIFulfillmentEventTriggerHelper.skipTrigger = true;
    objHIFulfillmentEvent.Processed_At__c = System.now().addHours(-2);
    objHIFulfillmentEvent.Event_Info__c = '{\"enrollment\":{\"id\":47431,\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431\"},\"recent_qles\":[{\"id\":1682,\"event\":\"marriage\",\"date_of_event\":\"2017-05-26\",\"file_upload_urls\":[],\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/qualifying_life_events/1682\"}],\"carrier_directory\":\"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132\",\"employee\":{\"id\":7757869431613363,\"first_name\":\"Vincent\",\"last_name\":\"Smitham\",\"middle_initial\":\"M\",\"status\":\"Active\",\"ssn\":\"123456789\",\"birthday\":\"1985-03-12\",\"company_id\":7757616923594875,\"hired_at\":\"2014-05-12\",\"employment_status\":\"full_time\",\"home_address\":{\"id\":7757727713689401,\"street_1\":\"4349 Bradley Circles\",\"street_2\":\"Suite 826\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90027\",\"country\":\"USA\",\"phone\":null,\"created_at\":\"2016-12-14T14:36:45.000-08:00\",\"updated_at\":\"2016-12-14T14:36:45.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":false},\"work_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"email\":\"schuyler.muller7757869449033705@turcottefisher.info\",\"gender\":\"male\",\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114/employees/7757869431613363\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363\"},\"company\":{\"id\":7757616923594875,\"name\":\"Kihn, Cole and Turner\",\"email\":\"justyn_dickens7757869449032810@bednar.com\",\"salesforce_account_id\":null,\"work_states\":[\"CA\"],\"sic_code\":\"6794\",\"mailing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"filing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"benefits_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"number_of_eligible_ees\":6,\"number_of_ineligible_ees\":0,\"has_federal_cobra\":null,\"is_suspended\":false,\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114\"},\"state_carriers\":[{\"id\":24,\"name\":\"Principal\",\"state\":\"CA\",\"key\":\"principal_ca\",\"url\":\"http://localhost:4001/national_carriers/48/state_carriers/24\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/principal_ca\",\"forms\":[]},{\"id\":5,\"name\":\"Kaiser Permanente\",\"state\":\"CA\",\"key\":\"kaiser_ca\",\"url\":\"http://localhost:4001/national_carriers/36/state_carriers/5\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/kaiser_ca\",\"forms\":[88268]}],\"benefit_items\":{\"dental\":{\"current\":null,\"overlapping\":[{\"id\":53794,\"policy_id\":15619,\"benefit_type\":\"dental\",\"subscriber_id\":\"22270388\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53794\"}],\"previous\":[]},\"medical\":{\"current\":{\"id\":98828,\"policy_id\":15841,\"benefit_type\":\"medical\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98828\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":763.9,\"estimated_employee_premium\":375.63,\"estimated_dependents_premium\":388.27,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[{\"id\":53793,\"policy_id\":15842,\"benefit_type\":\"medical\",\"subscriber_id\":\"61306767\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53793\"}],\"previous\":[]},\"vision\":{\"current\":{\"id\":98829,\"policy_id\":15634,\"benefit_type\":\"vision\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98829\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":19.51,\"estimated_employee_premium\":9.68,\"estimated_dependents_premium\":9.83,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[],\"previous\":[]}},\"policies\":[{\"id\":15619,\"name\":\"Principal Dental Plan 4\",\"benefit_type\":\"dental\",\"group_number\":\"1073605-10001\",\"policy_number\":null,\"plan_id\":2224,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15619\"},{\"id\":15631,\"name\":\"Silver 70 HMO 1000/50 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"344089\",\"policy_number\":null,\"plan_id\":2419,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15631\"},{\"id\":15634,\"name\":\"Principal Vision Plan 2\",\"benefit_type\":\"vision\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":1975,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15634\"},{\"id\":15841,\"name\":\"Platinum 90 HMO 0/10 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2413,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15841\"},{\"id\":15842,\"name\":\"Gold 80 HMO 0/30 w/ Child Dental, Acu\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2410,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15842\"}],\"dependents\":[{\"id\":16918,\"first_name\":\"Doug\",\"last_name\":\"Wintheiser\",\"ssn\":\"123456789\",\"birthday\":\"1983-07-03\",\"gender\":\"female\",\"dependent_type\":\"spouse\",\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/dependents/16918\"}],\"forms\":[{\"id\":88268,\"name\":\"2017 Kaiser CA Employee Change Form\",\"url\":\"http://localhost:4001/attachments/forms/88268\"}],\"answers\":[],"alegeus":{"fsa":{"benefit_items":{"current":{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302","estimated_start_date":"2017-08-01","ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]},"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]}},\"benefits_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions\",\"enrollments_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments\"}';
    update objHIFulfillmentEvent;
    HIFulfillmentEventTriggerHelper.skipTrigger = false;

    Test.startTest();
    Database.executeBatch(new HIFulfillmentEventBatch(), 10);
    Test.stopTest();
  }

  /**
   * @author       Deepika Saini
   * @description  This method is used to test the Dead HI Fulfillment Event record deletion.
   **/
  @isTest
  static void testFulfillmentEventBatchDeletionPositive() {
    Test.startTest();
    HIFulfillmentEventTriggerHelper.skipTrigger = true;
    HIFulfillmentEventTriggerHelper.queue = true;

    HI_Fulfillment_Event__c objHIFulfillmentEvent = new TestDataFactory.HIFulfillmentEventBuilder()
      .setId('Test321')
      .setEventType('audit')
      .setEventInfo(
        '{"audit_type":"Subscription Still Active for FT to PT EE","subject":"benefits_status_audit_out_of_sync","items":[{"id":2029500,"uuid":123401,"policy_id":175423,"benefit_type":"medical","subscriber_id":null,"processing_status":"not_started","start_date":null,"end_date":null,"enrollment_id":893286,"employee_id":933013701,"dependent_ids":[],"state_carrier_id":259,"url":"https://hippo.gusto.com/companies/7757616923723269/employees/7757869434138614/selections/2029500","type":"benefit_item"}],"instructions":null,"company":{"id":7757616923594875,"name":"Jaskolski, Nicolas and Feil","email":"edyth.hills7757869448393078@marvin.net","salesforce_account_id":null,"work_states":["IL","MA","NY"],"sic_code":"3699","mailing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"filing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"benefits_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"number_of_eligible_ees":8,"number_of_ineligible_ees":7,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.gusto-dev.com:3000/companies/7757616923480535","hippo_url":"http://localhost:4001/companies/7757616923480535"},"employee":{"hippo_url":"http://localhost:4001/companies/7757616923480535"}}'
      )
      .build();
    insert objHIFulfillmentEvent;
    objHIFulfillmentEvent.Processing_State__c = 'Error';
    objHIFulfillmentEvent.Processed_At__c = system.now();
    update objHIFulfillmentEvent;

    HI_Fulfillment_Event__c objHIFulfillmentEvent1 = new TestDataFactory.HIFulfillmentEventBuilder()
      .setId('Test323')
      .setEventType('audit')
      .setEventInfo(
        '{"audit_type":"Subscription Still Active for FT to PT EE","subject":"benefits_status_audit_out_of_sync","items":[{"id":2029500,"uuid":123401,"policy_id":175423,"benefit_type":"medical","subscriber_id":null,"processing_status":"not_started","start_date":null,"end_date":null,"enrollment_id":893286,"employee_id":933013701,"dependent_ids":[],"state_carrier_id":259,"url":"https://hippo.gusto.com/companies/7757616923723269/employees/7757869434138614/selections/2029500","type":"benefit_item"}],"instructions":null,"company":{"id":7757616923594875,"name":"Jaskolski, Nicolas and Feil","email":"edyth.hills7757869448393078@marvin.net","salesforce_account_id":null,"work_states":["IL","MA","NY"],"sic_code":"3699","mailing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"filing_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"benefits_address":{"id":7757727712754212,"street_1":"834 Reilly Junctions","street_2":"Apt. 915","city":"Chicago","county_name":"Cook","state":"IL","zip":"60640","country":"USA","phone":"8237165337","created_at":"2014-11-02T16:31:11.000-08:00","updated_at":"2014-11-02T16:31:11.000-08:00","fax":"7757527788","inactive":false,"work_address":true,"employee_count":11},"number_of_eligible_ees":8,"number_of_ineligible_ees":7,"has_federal_cobra":null,"is_suspended":false,"panda_url":"http://manage.gusto-dev.com:3000/companies/7757616923480535","hippo_url":"http://localhost:4001/companies/7757616923480535"},"employee":{"hippo_url":"http://localhost:4001/companies/7757616923480535"}}'
      )
      .build();
    insert objHIFulfillmentEvent1;
    objHIFulfillmentEvent1.Processing_State__c = 'Dead';

    update objHIFulfillmentEvent1;

    database.executeBatch(new HIFulfillmentEventBatch(), 10);
    Test.stopTest();

    List<HI_Fulfillment_Event__c> list_QueriedEvent = [
      SELECT Id, Processing_State__c, Processed_At__c
      FROM HI_Fulfillment_Event__c
      WHERE Processing_State__c = 'Error'
    ];

    List<HI_Fulfillment_Event__c> list_QueriedEvent1 = [
      SELECT Id, Processing_State__c, Processed_At__c
      FROM HI_Fulfillment_Event__c
      WHERE Processing_State__c = 'Dead'
    ];

    if (!list_QueriedEvent.IsEmpty()) {
      for (HI_Fulfillment_Event__c objHIFulfillmentEvents : list_QueriedEvent) {
        if (objHIFulfillmentEvents.Processing_State__c == 'Error') {
          objHIFulfillmentEvents.Processing_State__c = 'Dead';
        }
      }
      update list_QueriedEvent;
    }

    System.assertEquals(
      list_QueriedEvent[0].Processing_State__c,
      'Dead',
      'Processing State should be matched'
    );

    List<HI_Fulfillment_Event__c> list_newGroup = new List<HI_Fulfillment_Event__c>();

    for (HI_Fulfillment_Event__c objHIFulfillmentEvents1 : list_QueriedEvent1) {
      if (
        objHIFulfillmentEvents1.Processing_State__c == 'Dead' &&
        objHIFulfillmentEvents1.Processed_At__c < System.now().addDays(-180)
      ) {
        list_newGroup.add(objHIFulfillmentEvents1);
      }
    }
    if (!list_newGroup.IsEmpty()) {
      delete list_newGroup;
    }
  }

  /**
   * @Author      : Sanjay Paryani
   * @Description : Test scheduler for batch class picking up errorred records
   * @Parm        : N/A
   * @Return      : N/A
   **/
  @isTest
  static void testSchedulerExecution() {
    Utils.skipTrigger(true);
    HI_Fulfillment_Event__c objHIFulfillmentEvent = new TestDataFactory.HIFulfillmentEventBuilder()
      .setApplicationId('11001')
      .setCompanyId('72239')
      .setEventType('OA_intro_email')
      .setprocessingstate('Error')
      .setEventInfo(
        '{\"enrollment\":{\"id\":47431,\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431\"},\"recent_qles\":[{\"id\":1682,\"event\":\"marriage\",\"date_of_event\":\"2017-05-26\",\"file_upload_urls\":[],\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/qualifying_life_events/1682\"}],\"carrier_directory\":\"https://confluence.gustocorp.com/pages/viewpage.action?pageId=28803132\",\"employee\":{\"id\":7757869431613363,\"first_name\":\"Vincent\",\"last_name\":\"Smitham\",\"middle_initial\":\"M\",\"status\":\"Active\",\"ssn\":\"123456789\",\"birthday\":\"1985-03-12\",\"company_id\":111111,\"hired_at\":\"2014-05-12\",\"employment_status\":\"full_time\",\"home_address\":{\"id\":7757727713689401,\"street_1\":\"4349 Bradley Circles\",\"street_2\":\"Suite 826\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90027\",\"country\":\"USA\",\"phone\":null,\"created_at\":\"2016-12-14T14:36:45.000-08:00\",\"updated_at\":\"2016-12-14T14:36:45.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":false},\"work_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"email\":\"schuyler.muller7757869449033705@turcottefisher.info\",\"gender\":\"male\",\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114/employees/7757869431613363\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363\"},\"company\":{\"id\":111111,\"name\":\"Kihn, Cole and Turner\",\"email\":\"justyn_dickens7757869449032810@bednar.com\",\"salesforce_account_id\":null,\"work_states\":[\"CA\"],\"sic_code\":\"6794\",\"mailing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"filing_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"benefits_address\":{\"id\":7757727713687976,\"street_1\":\"427 O\'Reilly Ramp\",\"street_2\":\"Suite 475\",\"city\":\"Los Angeles\",\"county_name\":\"Los Angeles\",\"state\":\"CA\",\"zip\":\"90029\",\"country\":\"USA\",\"phone\":\"8899664872\",\"created_at\":\"2016-12-13T17:35:24.000-08:00\",\"updated_at\":\"2016-12-13T17:35:24.000-08:00\",\"fax\":null,\"inactive\":false,\"work_address\":true,\"employee_count\":6},\"number_of_eligible_ees\":6,\"number_of_ineligible_ees\":0,\"has_federal_cobra\":null,\"is_suspended\":false,\"panda_url\":\"http://manage.zenpayroll.dev:3000/companies/7757616923599114\",\"hippo_url\":\"http://localhost:4001/companies/7757616923599114\"},\"state_carriers\":[{\"id\":24,\"name\":\"Principal\",\"state\":\"CA\",\"key\":\"principal_ca\",\"url\":\"http://localhost:4001/national_carriers/48/state_carriers/24\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/principal_ca\",\"forms\":[]},{\"id\":5,\"name\":\"Kaiser Permanente\",\"state\":\"CA\",\"key\":\"kaiser_ca\",\"url\":\"http://localhost:4001/national_carriers/36/state_carriers/5\",\"carrier_enrollment_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments/47431/kaiser_ca\",\"forms\":[88268]}],\"benefit_items\":{\"dental\":{\"current\":null,\"overlapping\":[{\"id\":53794,\"policy_id\":15619,\"benefit_type\":\"dental\",\"subscriber_id\":\"22270388\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53794\"}],\"previous\":[]},\"medical\":{\"current\":{\"id\":98828,\"policy_id\":15841,\"benefit_type\":\"medical\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98828\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":763.9,\"estimated_employee_premium\":375.63,\"estimated_dependents_premium\":388.27,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[{\"id\":53793,\"policy_id\":15842,\"benefit_type\":\"medical\",\"subscriber_id\":\"61306767\",\"start_date\":\"2017-03-01\",\"end_date\":\"2018-02-28\",\"processed\":true,\"enrollment_id\":25666,\"employee_id\":7757869431613363,\"dependent_ids\":[],\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/53793\"}],\"previous\":[]},\"vision\":{\"current\":{\"id\":98829,\"policy_id\":15634,\"benefit_type\":\"vision\",\"subscriber_id\":null,\"start_date\":null,\"end_date\":null,\"processed\":false,\"enrollment_id\":47431,\"employee_id\":7757869431613363,\"dependent_ids\":[16918],\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions/98829\",\"estimated_start_date\":\"2017-05-26\",\"estimated_total_premium\":19.51,\"estimated_employee_premium\":9.68,\"estimated_dependents_premium\":9.83,\"ops_owner\":\"member_fulfillment\"},\"overlapping\":[],\"previous\":[]}},\"policies\":[{\"id\":15619,\"name\":\"Principal Dental Plan 4\",\"benefit_type\":\"dental\",\"group_number\":\"1073605-10001\",\"policy_number\":null,\"plan_id\":2224,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15619\"},{\"id\":15631,\"name\":\"Silver 70 HMO 1000/50 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"344089\",\"policy_number\":null,\"plan_id\":2419,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15631\"},{\"id\":15634,\"name\":\"Principal Vision Plan 2\",\"benefit_type\":\"vision\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":1975,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":24,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15634\"},{\"id\":15841,\"name\":\"Platinum 90 HMO 0/10 + Child Dental Alt\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2413,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15841\"},{\"id\":15842,\"name\":\"Gold 80 HMO 0/30 w/ Child Dental, Acu\",\"benefit_type\":\"medical\",\"group_number\":\"\",\"policy_number\":null,\"plan_id\":2410,\"visible\":true,\"termination_policy\":\"last_day_of_month_on_or_after_termination\",\"state_carrier_id\":5,\"url\":\"http://localhost:4001/companies/7757616923599114/policies/15842\"}],\"dependents\":[{\"id\":16918,\"first_name\":\"Doug\",\"last_name\":\"Wintheiser\",\"ssn\":\"123456789\",\"birthday\":\"1983-07-03\",\"gender\":\"female\",\"dependent_type\":\"spouse\",\"employee_id\":7757869431613363,\"url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/dependents/16918\"}],\"forms\":[{\"id\":88268,\"name\":\"2017 Kaiser CA Employee Change Form\",\"url\":\"http://localhost:4001/attachments/forms/88268\"}],\"answers\":[],"alegeus":{"fsa":{"benefit_items":{"current":{"id":103302,"policy_id":26484,"benefit_type":"fsa","subscriber_id":null,"start_date":null,"end_date":null,"processed":false,"enrollment_id":48910,"employee_id":7757869431795591,"employee_alegeus_id":218828899,"dependent_ids":[],"url":"http://localhost:4001/companies/1370368242490000/employees/7757869431795591/subscriptions/103302","estimated_start_date":"2017-08-01","ops_owner":"member_fulfillment"},"overlapping":[],"previous":[]},"policies":[{"id":26484,"name":"Health FSA","benefit_type":"fsa","company_alegeus_id":964954019,"visible":true,"termination_policy":"last_day_of_employment","url":"http://localhost:4001/companies/1370368242490000/policies/26484"}]}},\"benefits_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/subscriptions\",\"enrollments_url\":\"http://localhost:4001/companies/7757616923599114/employees/7757869431613363/enrollments\"}'
      )
      .build();
    insert objHIFulfillmentEvent;
    Utils.skipTrigger(false);

    Test.startTest();
    String CRON_EXP = '0 0 * * * ?';
    HIFulfillmentEventBatch sch = new HIFulfillmentEventBatch();
    System.schedule(
      'HIFulfillmentEventBatchScheduler Hourly Example Batch Schedule job',
      CRON_EXP,
      sch
    );
    Test.stopTest();

    List<HI_Fulfillment_Event__c> list_QueriedEvents = [
      SELECT Id, Processing_State__c
      FROM HI_Fulfillment_Event__c
      WHERE Application_Id__c = '11001'
    ];
    System.assertEquals(list_QueriedEvents.size() > 0, true);
  }
}